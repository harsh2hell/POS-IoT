{% extends "base.html" %}
{% block content %}

<div class="row g-4">
  <!-- LEFT -->
  <div class="col-lg-7">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">Order Items</h2>
        <small class="text-muted">Select food & quantities</small>
      </div>
      <input class="form-control w-50" placeholder="Search item..."
             oninput="filterItems(this.value)">
    </div>

    <div class="card reveal card-hover">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th>Category</th>
                <th class="text-end">Price</th>
                <th class="text-center">Qty</th>
              </tr>
            </thead>
            <tbody>
            {% for name, price, available, category in items %}
              <tr class="item-row"
                  data-name="{{ name }}"
                  data-price="{{ price }}"
                  data-available="{{ available }}">
                <td class="item-name">{{ name }}</td>
                <td>{{ category or '—' }}</td>
                <td class="text-end">₹{{ "%.2f"|format(price) }}</td>
                <td class="text-center">
                  {% if available %}
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="changeQty(this,-1)">−</button>
                    <input class="qty-input form-control text-center" value="0" readonly>
                    <button class="btn btn-outline-secondary" onclick="changeQty(this,1)">+</button>
                  </div>
                  {% else %}
                    <span class="text-muted">Out</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-lg-5">
    <form method="POST" action="{{ url_for('generate_qr') }}" id="billForm">
      <div class="card reveal card-hover sticky-top" style="top:90px">
        <div class="card-body">
          <h4 class="mb-2">Bill Summary</h4>

          <div class="d-flex justify-content-between">
            <span class="text-muted">Items</span>
            <span id="summary-items">0</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Subtotal</span>
            <span id="summary-subtotal">₹0.00</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">GST</span>
            <span id="summary-gst">₹0.00</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between fs-5 fw-semibold">
            <span>Total</span>
            <span id="summary-total">₹0.00</span>
          </div>

          <input type="hidden" name="cart" id="cartInput">

          <button class="btn btn-primary w-100 mt-3" id="payBtn" disabled>
            <span class="btn-text">Generate QR</span>
            <span class="spinner-border spinner-border-sm d-none"></span>
          </button>

          <button type="button" class="btn btn-link w-100" onclick="resetBill()">
            Clear Order
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function changeQty(btn, d) {
  const input = btn.parentElement.querySelector('.qty-input');
  input.value = Math.max(0, (+input.value) + d);
  updateSummary();
}

function updateSummary() {
  let items=0, subtotal=0;
  const cart=[];
  document.querySelectorAll('.item-row').forEach(r=>{
    const q=+r.querySelector('.qty-input')?.value||0;
    if(q>0){
      items+=q;
      subtotal+=q*parseFloat(r.dataset.price);
      cart.push({name:r.dataset.name,quantity:q});
    }
  });
  const gst=subtotal*0.18;
  document.getElementById('summary-items').textContent=items;
  document.getElementById('summary-subtotal').textContent=`₹${subtotal.toFixed(2)}`;
  document.getElementById('summary-gst').textContent=`₹${gst.toFixed(2)}`;
  document.getElementById('summary-total').textContent=`₹${(subtotal+gst).toFixed(2)}`;
  document.getElementById('cartInput').value=JSON.stringify(cart);
  document.getElementById('payBtn').disabled=cart.length===0;
}

document.getElementById('billForm').addEventListener('submit',()=>{
  const btn=document.getElementById('payBtn');
  btn.disabled=true;
  btn.querySelector('.btn-text').textContent='Generating...';
  btn.querySelector('.spinner-border').classList.remove('d-none');
});
</script>
{% endblock %}
